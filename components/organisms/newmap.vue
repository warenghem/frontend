<template>
  <div class="h-100">
    <div style="height: 500px; width: 100%" class="pa-0">
      <l-map
        class="treemap h-100"
        ref="map"
        @ready="onReady"
        :zoom="zoom"
        :center="center"
        :options="{zoomControl: false,attributionControl: false,scrollWheelZoom: false,tap: false,boxZoom: false, doubleClickZoom: false, touchZoom: false, dragging: false, draggable: false}"
      >
        <l-tile-layer
          :url="url"
        />
        <!--<l-geo-json
                v-for="(data,i ) in polylines.routes" :key="i"
                :geojson="decode(data.sections.polyline)"
                />-->
        <l-marker v-for="(marker, index) in markers" :key="index"
                  :lat-lng="[marker.location.latitude, marker.location.longitude]"
                  @click="openModal(marker.id)"
                  >
          <l-icon
            :icon-size="[50, 50]"
            className="mapClass hand"
            icon-class="e"
          >
            <div class="card">
              <div class="card-header name hand">
               {{marker.name}}
               <div style="font-size: 16px" class="subtitlesmall d-none">En savoir plus</div>
              </div>
              <div>
                <div class="blob white rounded-circle" style="width:35px; height:35px">
                  <img  alt="" width="35" height="35">
                </div>
              </div>
            </div>
          </l-icon>
        </l-marker>
      </l-map>
    </div>
    <div style="color:black">{{polylines.routes}}</div>
    <div
        v-for="(polyline,i ) in polylines" :key="i"
    >{{polyline}}</div>
    <SideModalMap :is-modal="currentModal" v-on:closeModal="currentModal=false" :provider="provider" :current="currentModal"/>
  </div>
</template>
<script>
    import { LMap, LTileLayer, LMarker, LIcon, LGeoJson } from 'vue2-leaflet';
    import 'leaflet/dist/leaflet.css';
    import { mdiClose } from '@mdi/js';
    import L from 'leaflet';
    import H from '~/utils/flexiblepolyline.js'
    delete L.Icon.Default.prototype._getIconUrl;

    L.Icon.Default.mergeOptions({
      iconRetinaUrl: require('leaflet/dist/images/marker-icon-2x.png'),
      iconUrl: require('leaflet/dist/images/marker-icon.png'),
      shadowUrl: require('leaflet/dist/images/marker-shadow.png'),
    });

    export default {
        name: 'origin-map',
        components: {
              LMap,
              LTileLayer,
              LMarker,
              LIcon,
              LGeoJson
        },
        props: {
            markers: {
                type: Array,
                default: () => {
                }
            },
            providersItem: {
                type: Array,
                default: () => {
                }
            }
        },
        async fetch() {
          this.polylines = await fetch('https://router.hereapi.com/v8/routes?transportMode=car&apiKey=sJxvIvQjWZuvxGBtUHZ7b1cjjmuB5IhIj5Dd47MLEMM&origin=45.698572,9.6719618&destination=47.4595,-0.7948&return=polyline').then(res =>
            res.json()
          )
        },
        data() {
            return {
                datas: [],
                svgPath: mdiClose,
                zoom: 2,
                center: [30, 66],
                url: 'https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png',
                showParagraph: false,
                showMap: true,
                markers: [],
                currentModal: false,
                polylines: [],
                datas: [],
            };
        },
        /*computed: {
          manufacturer() {
                  var manufacturer = this.polylines.routes.find(y => y.id.includes('d562b6ff-f834-4cf7-8c2a-5bbf09575a5c'))
                  return manufacturer
            },
        },*/
        methods: {
            onReady() {
              if (this.markers.length) {
                this.$nextTick(() => {
                  this.$refs.map.mapObject.fitBounds(this.markers.map(m => { return [m.location.latitude, m.location.longitude] }))
                })
              }
            },
            DarkMode() {
              if ($vuetify.theme.dark) {
                  this.mapstyle = 'https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png';
              } else {
                  this.mapstyle = 'https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png';
              }
            },
            zoomUpdate(zoom) {
                this.currentZoom = zoom;
            },
            centerUpdate(center) {
                this.currentCenter = center;
            },
            openModal(modalName) {
                this.currentModal = true
                this.provider = this.providersItem.find(y => y.slug.includes(modalName))
            },
            decode(str){
              let lines = H.decode(str);
              return {
                  "type": "Feature",
                  "geometry": {
                      "type": "LineString",
                      "coordinates": lines.polyline
                  }
              };
            }
        },
    }
</script>

<style lang="scss" scoped>
.leaflet-container {
    font-family: "teradeli-book";
}
  .treemap {
    z-index: 1;
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
    }

  .slideArea {
    position: fixed;
    top: 0;
    bottom: 0;
    height: 100%;
    z-index: 100000 !important;
    background: white;
    max-height: 100%;
    overflow-y: scroll;
    transition: right 0.4s;

    .card-header {
      position: fixed;
      z-index: 1;
      background: white;
    }

    @media only screen and (min-width: 1291px) {
      width: 50vw !important;
      right: -50vw !important;
      .card-header {
        width: 49vw !important;
      }
    }

    @media only screen and (max-width: 1290px) {
      width: 70vw !important;
      right: -70vw;
      .card-header {
        width: 69vw !important;
      }
    }
    @media only screen and (max-width: 48em) {
      width: 100vw !important;
      right: -100vw;
      .card-header {
        width: 99vw !important;
      }
    }

    &.active {
      right: 0 !important;
      visibility: visible !important;
    }

  }

  .leaflet-marker-icon img {
    border-radius: 50%;
  }
  .blobs-container {
    display: flex;
  }
  .blob.white {
    background: white;
    box-shadow: 0 0 0 0 rgba(0, 129, 167,0.8);
    animation: pulse-white 2s infinite;
  }
  @keyframes pulse-white {
    0% {
    transform: scale(0.9);
    box-shadow: 0 0 0 0 rgba(0, 129, 167, 0.6);
    }

    70% {
    transform: scale(1);
    box-shadow: 0 0 0 10px rgba(0, 129, 167, 0);
    }

    100% {
    transform: scale(0.9);
    box-shadow: 0 0 0 0 rgba(0, 129, 167, 0);
    }
  }
</style>
